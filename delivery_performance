WITH sold_combined AS (
    SELECT * FROM data.sold_record_archive
    UNION ALL
    SELECT * FROM data.sold_record
),
base_data AS (
    SELECT 
        region,
        DATE(st.insert_time) AS date,
        WEEK_OF_YEAR(st.insert_time) AS week,  -- For Presto/Trino/Athena
        LPAD(CAST(EXTRACT(MONTH FROM st.insert_time) AS VARCHAR), 2, '0') AS month,
        st.deliver_way,
        COALESCE(ROUND(st.amount * cd.g_num), 0) AS gmv
    FROM data.transaction st
    LEFT JOIN sold_combined cd ON st.transaction_no = cd.transaction_no  -- same as USING (transaction_no)
    WHERE st.deliver_way IS NOT NULL
           AND st.amount IS NOT NULL
),
aggregated AS (
    SELECT 
        region,
        date,
        week,
        month,
        SUM(gmv) AS gmv,
        SUM(CASE WHEN deliver_way = 'International' THEN gmv ELSE 0 END) AS gmv_international,
        SUM(CASE WHEN deliver_way = 'International' THEN gmv ELSE 0 END) / NULLIF(SUM(gmv), 0) AS ratio
    FROM base_data
    GROUP BY region, date, week, month
),
percentile_threshold AS (
    SELECT APPROX_PERCENTILE(ratio, 0.7) AS p70   -- Use PERCENTILE_CONT for PostgreSQL
    FROM aggregated
    WHERE ratio IS NOT NULL
)
SELECT a.*
FROM aggregated a
CROSS JOIN percentile_threshold pt
WHERE a.ratio >= pt.p70
ORDER BY a.region, a.date;
